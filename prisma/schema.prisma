generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи платформы (владельцы бизнесов)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String

  // Верификация email
  emailVerified Boolean   @default(false)
  verificationToken String? @unique
  verificationExpires DateTime?

  // Настройки
  theme         String    @default("dark") // dark, light

  // Настройки уведомлений
  notifyNewBookings    Boolean @default(true)
  notifyCancellations  Boolean @default(true)
  notifyLowMessages    Boolean @default(true)
  notifyTrialEnding    Boolean @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  businesses    Business[]
  supportTickets SupportTicket[]
}

// Бизнесы
model Business {
  id            String    @id @default(cuid())
  name          String
  phone         String?
  address       String?
  workingHours  String?
  welcomeMessage String?

  // Onboarding
  businessType  String?   // salon, clinic, barbershop, auto_service, other
  staffCount    Int?      // количество сотрудников
  language      String    @default("ru") // ru, uz, kz, kg, tj, am, ge
  onboardingCompleted Boolean @default(false)

  // AI настройки
  aiTone        String?   // friendly, professional, casual
  aiRules       String?   // что можно/нельзя говорить
  systemPrompt  String?   // сгенерированный промпт для AI

  // Telegram bot
  botToken      String?   @unique
  botUsername   String?
  botActive     Boolean   @default(false)
  botLogo       String?   // URL к логотипу бота

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  services      Service[]
  staff         Staff[]
  faqs          FAQ[]
  bookings      Booking[]
  conversations Conversation[]
  subscription  Subscription?
  documents     Document[]

  // Автоматизации
  automationSettings AutomationSettings?
  scheduledReminders ScheduledReminder[]
  reviews            Review[]
  clients            Client[]
}

// Услуги
model Service {
  id            String    @id @default(cuid())
  name          String
  price         Int
  duration      Int       // минуты

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  bookings      Booking[]
}

// Мастера/сотрудники
model Staff {
  id            String    @id @default(cuid())
  name          String
  role          String?

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  bookings      Booking[]
}

// FAQ / База знаний
model FAQ {
  id            String    @id @default(cuid())
  question      String
  answer        String

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// Записи клиентов
model Booking {
  id            String    @id @default(cuid())
  clientName    String
  clientPhone   String?
  clientTelegramId BigInt?

  date          DateTime
  status        String    @default("pending") // pending, confirmed, cancelled, completed

  // Флаги напоминаний
  reminder24hSent Boolean @default(false)
  reminder2hSent  Boolean @default(false)
  reviewRequested Boolean @default(false)

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  serviceId     String?
  service       Service?  @relation(fields: [serviceId], references: [id])

  staffId       String?
  staff         Staff?    @relation(fields: [staffId], references: [id])

  // Автоматизации
  reminders     ScheduledReminder[]
  reviews       Review[]

  createdAt     DateTime  @default(now())
}

// Диалоги с клиентами
model Conversation {
  id                  String    @id @default(cuid())
  clientTelegramId    BigInt
  clientName          String?

  businessId          String
  business            Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  messages            Message[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([businessId, clientTelegramId])
}

// Сообщения в диалогах
model Message {
  id              String    @id @default(cuid())
  role            String    // user, assistant
  content         String

  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
}

// Подписки
model Subscription {
  id              String    @id @default(cuid())
  plan            String    @default("trial") // trial, starter, business, pro
  messagesUsed    Int       @default(0)
  messagesLimit   Int       @default(100)
  expiresAt       DateTime

  businessId      String    @unique
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Загруженные документы
model Document {
  id            String    @id @default(cuid())
  name          String    // имя файла
  type          String    // price_list, services, faq, other
  url           String    // URL к файлу
  mimeType      String    // application/pdf, etc.
  size          Int       // размер в байтах

  // Извлечённые данные
  extractedText String?   // текст из документа
  parsed        Boolean   @default(false) // был ли распарсен AI

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
}

// Тикеты поддержки
model SupportTicket {
  id            String    @id @default(cuid())
  subject       String
  priority      String    @default("normal") // low, normal, high
  status        String    @default("open")   // open, in_progress, resolved, closed

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages      SupportMessage[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Сообщения в тикетах поддержки
model SupportMessage {
  id            String    @id @default(cuid())
  content       String
  isFromSupport Boolean   @default(false) // true = от поддержки, false = от пользователя
  isRead        Boolean   @default(false) // прочитано ли пользователем
  readAt        DateTime?                 // когда прочитано

  ticketId      String
  ticket        SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
}

// ========================================
// АВТОМАТИЗАЦИИ
// ========================================

// Настройки автоматизаций для бизнеса
model AutomationSettings {
  id                    String    @id @default(cuid())

  // Напоминания о записи
  reminder24hEnabled    Boolean   @default(true)
  reminder2hEnabled     Boolean   @default(true)

  // Сбор отзывов
  reviewEnabled         Boolean   @default(true)
  reviewDelayHours      Int       @default(2)    // через сколько часов после визита
  reviewGoogleLink      String?                  // ссылка на Google отзывы
  review2gisLink        String?                  // ссылка на 2GIS отзывы

  // Реактивация клиентов
  reactivationEnabled   Boolean   @default(true)
  reactivationDays      Int       @default(30)   // через сколько дней без визита
  reactivationDiscount  Int       @default(10)   // размер скидки %

  businessId            String    @unique
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// Запланированные напоминания
model ScheduledReminder {
  id              String    @id @default(cuid())

  type            String    // reminder_24h, reminder_2h, review, reactivation
  status          String    @default("pending") // pending, sent, failed, cancelled

  scheduledFor    DateTime  // когда отправить
  sentAt          DateTime? // когда отправлено

  // Данные для отправки
  clientTelegramId BigInt
  clientName      String?
  serviceName     String?
  appointmentDate DateTime?

  // Для реактивации
  lastVisitDate   DateTime?
  discountCode    String?

  bookingId       String?
  booking         Booking?  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@index([status, scheduledFor])
  @@index([businessId, type])
}

// Отзывы клиентов
model Review {
  id              String    @id @default(cuid())

  rating          Int       // 1-5
  comment         String?

  clientTelegramId BigInt
  clientName      String?

  // Связь с записью
  bookingId       String?
  booking         Booking?  @relation(fields: [bookingId], references: [id])

  // Статус
  isPublic        Boolean   @default(false)   // опубликован ли
  responded       Boolean   @default(false)   // ответил ли бизнес
  responseText    String?                     // ответ бизнеса

  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@index([businessId, rating])
}

// Клиенты (для отслеживания последнего визита)
model Client {
  id                String    @id @default(cuid())

  telegramId        BigInt
  name              String?
  phone             String?

  // Статус
  lastVisitDate     DateTime?
  totalVisits       Int       @default(0)
  isBlocked         Boolean   @default(false)  // отписался от рассылок

  // Последняя реактивация
  lastReactivationSent DateTime?

  businessId        String
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([businessId, telegramId])
  @@index([businessId, lastVisitDate])
}
