generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи платформы (владельцы бизнесов)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String

  // Верификация email
  emailVerified Boolean   @default(false)
  verificationToken String? @unique
  verificationExpires DateTime?

  // Настройки
  theme         String    @default("dark") // dark, light

  // Настройки уведомлений
  notifyNewBookings    Boolean @default(true)
  notifyCancellations  Boolean @default(true)
  notifyLowMessages    Boolean @default(true)
  notifyTrialEnding    Boolean @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  businesses    Business[]
  supportTickets SupportTicket[]
}

// Бизнесы
model Business {
  id            String    @id @default(cuid())
  name          String
  phone         String?
  address       String?
  workingHours  String?
  welcomeMessage String?

  // Onboarding
  businessType  String?   // salon, clinic, barbershop, auto_service, other
  staffCount    Int?      // количество сотрудников
  language      String    @default("ru") // ru, uz, kz, kg, tj, am, ge
  onboardingCompleted Boolean @default(false)

  // AI настройки
  aiTone        String?   // friendly, professional, casual
  aiRules       String?   // что можно/нельзя говорить
  systemPrompt  String?   // сгенерированный промпт для AI

  // Telegram bot
  botToken      String?   @unique
  botUsername   String?
  botActive     Boolean   @default(false)
  botLogo       String?   // URL к логотипу бота

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  services      Service[]
  staff         Staff[]
  faqs          FAQ[]
  bookings      Booking[]
  conversations Conversation[]
  subscription  Subscription?
  documents     Document[]

  // Автоматизации
  automationSettings AutomationSettings?
  scheduledReminders ScheduledReminder[]
  reviews            Review[]
  clients            Client[]

  // Рассылки клиентам
  clientBroadcasts   ClientBroadcast[]

  // Мультиканальность (WhatsApp, Instagram)
  channelConnections ChannelConnection[]
  channelClients     ChannelClient[]
}

// Услуги
model Service {
  id            String    @id @default(cuid())
  name          String
  price         Int
  duration      Int       // минуты

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  bookings      Booking[]
}

// Мастера/сотрудники
model Staff {
  id            String    @id @default(cuid())
  name          String
  role          String?

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  bookings      Booking[]
}

// FAQ / База знаний
model FAQ {
  id            String    @id @default(cuid())
  question      String
  answer        String

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

// Записи клиентов
model Booking {
  id            String    @id @default(cuid())
  clientName    String
  clientPhone   String?
  clientTelegramId BigInt?

  date          DateTime
  status        String    @default("pending") // pending, confirmed, cancelled, completed

  // Флаги напоминаний
  reminder24hSent Boolean @default(false)
  reminder2hSent  Boolean @default(false)
  reviewRequested Boolean @default(false)

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  serviceId     String?
  service       Service?  @relation(fields: [serviceId], references: [id])

  staffId       String?
  staff         Staff?    @relation(fields: [staffId], references: [id])

  // Автоматизации
  reminders     ScheduledReminder[]
  reviews       Review[]

  createdAt     DateTime  @default(now())
}

// Диалоги с клиентами
model Conversation {
  id                  String    @id @default(cuid())
  clientTelegramId    BigInt
  clientName          String?

  businessId          String
  business            Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  messages            Message[]

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([businessId, clientTelegramId])
}

// Сообщения в диалогах
model Message {
  id              String    @id @default(cuid())
  role            String    // user, assistant
  content         String

  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
}

// Подписки
model Subscription {
  id              String    @id @default(cuid())
  plan            String    @default("trial") // trial, starter, business, pro
  messagesUsed    Int       @default(0)
  messagesLimit   Int       @default(100)
  expiresAt       DateTime

  businessId      String    @unique
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Загруженные документы
model Document {
  id            String    @id @default(cuid())
  name          String    // имя файла
  type          String    // price_list, services, faq, other
  url           String    // URL к файлу
  mimeType      String    // application/pdf, etc.
  size          Int       // размер в байтах

  // Извлечённые данные
  extractedText String?   // текст из документа
  parsed        Boolean   @default(false) // был ли распарсен AI

  businessId    String
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
}

// Тикеты поддержки
model SupportTicket {
  id            String    @id @default(cuid())
  subject       String
  priority      String    @default("normal") // low, normal, high
  status        String    @default("open")   // open, in_progress, resolved, closed

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages      SupportMessage[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Сообщения в тикетах поддержки
model SupportMessage {
  id            String    @id @default(cuid())
  content       String
  isFromSupport Boolean   @default(false) // true = от поддержки, false = от пользователя
  isRead        Boolean   @default(false) // прочитано ли пользователем
  readAt        DateTime?                 // когда прочитано

  ticketId      String
  ticket        SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
}

// ========================================
// АВТОМАТИЗАЦИИ
// ========================================

// Настройки автоматизаций для бизнеса
model AutomationSettings {
  id                    String    @id @default(cuid())

  // Напоминания о записи
  reminder24hEnabled    Boolean   @default(true)
  reminder2hEnabled     Boolean   @default(true)

  // Сбор отзывов
  reviewEnabled         Boolean   @default(true)
  reviewDelayHours      Int       @default(2)    // через сколько часов после визита
  reviewGoogleLink      String?                  // ссылка на Google отзывы
  review2gisLink        String?                  // ссылка на 2GIS отзывы

  // Реактивация клиентов
  reactivationEnabled   Boolean   @default(true)
  reactivationDays      Int       @default(30)   // через сколько дней без визита
  reactivationDiscount  Int       @default(10)   // размер скидки %

  businessId            String    @unique
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// Запланированные напоминания
model ScheduledReminder {
  id              String    @id @default(cuid())

  type            String    // reminder_24h, reminder_2h, review, reactivation
  status          String    @default("pending") // pending, sent, failed, cancelled

  scheduledFor    DateTime  // когда отправить
  sentAt          DateTime? // когда отправлено

  // Данные для отправки
  clientTelegramId BigInt
  clientName      String?
  serviceName     String?
  appointmentDate DateTime?

  // Для реактивации
  lastVisitDate   DateTime?
  discountCode    String?

  bookingId       String?
  booking         Booking?  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@index([status, scheduledFor])
  @@index([businessId, type])
}

// Отзывы клиентов
model Review {
  id              String    @id @default(cuid())

  rating          Int       // 1-5
  comment         String?

  clientTelegramId BigInt
  clientName      String?

  // Связь с записью
  bookingId       String?
  booking         Booking?  @relation(fields: [bookingId], references: [id])

  // Статус
  isPublic        Boolean   @default(false)   // опубликован ли
  responded       Boolean   @default(false)   // ответил ли бизнес
  responseText    String?                     // ответ бизнеса

  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@index([businessId, rating])
}

// Клиенты (для отслеживания последнего визита)
model Client {
  id                String    @id @default(cuid())

  telegramId        BigInt
  name              String?
  phone             String?

  // Статус
  lastVisitDate     DateTime?
  totalVisits       Int       @default(0)
  isBlocked         Boolean   @default(false)  // отписался от рассылок

  // Последняя реактивация
  lastReactivationSent DateTime?

  businessId        String
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([businessId, telegramId])
  @@index([businessId, lastVisitDate])
}

// ========================================
// ADMIN CRM - АВТОМАТИЗАЦИИ И РАССЫЛКИ
// ========================================

// Автоматизации для админа (триггеры + действия)
model AdminAutomation {
  id              String    @id @default(cuid())
  name            String
  description     String?

  // Триггер
  trigger         String    // trial_expiring, trial_expired, messages_low, etc.
  triggerParams   Json      @default("{}")

  // Действие
  action          String    // send_email, send_telegram, extend_trial, etc.
  actionParams    Json      @default("{}")

  isActive        Boolean   @default(true)

  executions      AutomationExecution[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Логи выполнения автоматизаций
model AutomationExecution {
  id              String    @id @default(cuid())

  automationId    String
  automation      AdminAutomation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  // Для кого сработало
  userId          String?
  userEmail       String?

  // Результат
  success         Boolean
  error           String?
  details         Json      @default("{}")

  createdAt       DateTime  @default(now())

  @@index([automationId, createdAt])
}

// Рассылки от админа
model Broadcast {
  id              String    @id @default(cuid())
  name            String

  // Контент
  subject         String?   // для email
  content         String    // текст сообщения

  // Канал
  channel         String    // email, telegram, in_app

  // Фильтры получателей
  targetPlan      String?   // all, trial, pro, business
  targetStatus    String?   // all, active, expired, expiring

  // Статус
  status          String    @default("draft") // draft, scheduled, sending, sent, cancelled
  scheduledFor    DateTime?
  sentAt          DateTime?

  // Статистика
  totalRecipients Int       @default(0)
  delivered       Int       @default(0)
  opened          Int       @default(0)
  clicked         Int       @default(0)

  deliveries      BroadcastDelivery[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Доставка рассылки
model BroadcastDelivery {
  id              String    @id @default(cuid())

  broadcastId     String
  broadcast       Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  // Получатель
  userId          String
  userEmail       String

  // Статус
  status          String    @default("pending") // pending, sent, delivered, opened, clicked, failed
  sentAt          DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  error           String?

  createdAt       DateTime  @default(now())

  @@index([broadcastId, status])
  @@index([userId])
}

// Теги пользователей для сегментации
model UserTag {
  id              String    @id @default(cuid())
  userId          String
  tag             String

  createdAt       DateTime  @default(now())

  @@unique([userId, tag])
  @@index([tag])
}

// ========================================
// MULTI-CHANNEL MESSAGING (WhatsApp, Instagram)
// ========================================

// Подключение каналов (WhatsApp, Instagram, Telegram)
model ChannelConnection {
  id                    String    @id @default(cuid())

  channel               String    // telegram, whatsapp, instagram
  isConnected           Boolean   @default(false)
  isVerified            Boolean   @default(false)

  // Telegram
  telegramBotId         String?
  telegramBotUsername   String?

  // WhatsApp Business API
  whatsappPhoneId       String?   // Phone Number ID from Meta
  whatsappPhoneNumber   String?   // Display phone number
  whatsappBusinessAccId String?   // WhatsApp Business Account ID

  // Instagram
  instagramAccountId    String?   // Instagram Account ID
  instagramUsername     String?
  instagramPageId       String?   // Connected Facebook Page ID

  // Meta API credentials (shared for WhatsApp & Instagram)
  metaAccessToken       String?   // Access token
  metaTokenExpiresAt    DateTime?

  // Webhook
  webhookUrl            String?
  webhookSecret         String?
  webhookVerified       Boolean   @default(false)

  // Status
  errorMessage          String?
  errorAt               DateTime?

  connectedAt           DateTime?
  lastActivityAt        DateTime?

  businessId            String
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([businessId, channel])
  @@index([channel, isConnected])
}

// Клиенты со всех каналов (унифицированные)
model ChannelClient {
  id                    String    @id @default(cuid())

  // Имя
  name                  String?
  firstName             String?
  lastName              String?

  // Telegram
  telegramId            String?
  telegramUsername      String?
  telegramChatId        String?

  // WhatsApp
  whatsappPhone         String?
  whatsappId            String?

  // Instagram
  instagramId           String?
  instagramUsername     String?

  // Контактные данные
  email                 String?
  phone                 String?

  // Профиль
  profilePicUrl         String?
  language              String?
  timezone              String?

  // Вовлечённость
  firstContactAt        DateTime  @default(now())
  lastContactAt         DateTime  @default(now())
  lastChannel           String?   // telegram, whatsapp, instagram
  totalMessages         Int       @default(0)

  // Кастомизация
  tags                  String[]  @default([])
  notes                 String?
  customFields          Json?

  businessId            String
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Связи
  messages              ChannelMessage[]
  leads                 Lead[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([businessId, telegramId])
  @@index([businessId, whatsappPhone])
  @@index([businessId, instagramId])
  @@index([businessId, lastContactAt])
}

// Сообщения из всех каналов
model ChannelMessage {
  id                    String    @id @default(cuid())

  channel               String    // telegram, whatsapp, instagram
  channelMessageId      String?   // ID сообщения в канале
  chatId                String    // ID чата в канале

  direction             String    // incoming, outgoing
  status                String    @default("sent") // pending, sent, delivered, read, failed

  // Контент
  text                  String?
  attachments           Json?     // [{type, url, ...}]

  // AI обработка
  aiProcessed           Boolean   @default(false)
  aiResponse            String?

  // Статусы доставки
  sentAt                DateTime?
  deliveredAt           DateTime?
  readAt                DateTime?

  // Ошибки
  errorMessage          String?
  errorCode             String?

  // Метаданные
  metadata              Json?

  clientId              String?
  client                ChannelClient? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  businessId            String

  createdAt             DateTime  @default(now())

  @@index([businessId, channel])
  @@index([businessId, clientId])
  @@index([chatId, channel])
}

// Лиды (из рекламы Instagram/WhatsApp)
model Lead {
  id                    String    @id @default(cuid())

  source                String    // instagram_ad, whatsapp_ctwa, organic, referral
  adId                  String?   // ID рекламы
  channel               String    // telegram, whatsapp, instagram

  firstMessage          String?   // Первое сообщение клиента
  status                String    @default("new") // new, contacted, qualified, converted, lost

  // Оценка
  score                 Int       @default(0)     // 0-100
  qualifiedAt           DateTime?
  convertedAt           DateTime?

  // Метаданные
  metadata              Json?
  notes                 String?

  clientId              String?
  client                ChannelClient? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  businessId            String

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([businessId, source])
  @@index([businessId, status])
  @@index([businessId, createdAt])
}

// ========================================
// CLIENT CRM - РАССЫЛКИ ДЛЯ КЛИЕНТОВ БИЗНЕСА
// ========================================

// Рассылки от бизнеса своим клиентам
model ClientBroadcast {
  id              String    @id @default(cuid())

  title           String    // название рассылки
  content         String    // текст сообщения

  // Сегментация
  targetSegment   String    @default("all") // all, vip, active, inactive

  // Статус
  status          String    @default("draft") // draft, scheduled, sending, sent, cancelled
  scheduledAt     DateTime?
  sentAt          DateTime?

  // Статистика
  recipientsCount Int       @default(0)

  businessId      String
  business        Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  deliveries      ClientBroadcastDelivery[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([businessId, status])
}

// Доставка рассылки клиенту
model ClientBroadcastDelivery {
  id              String    @id @default(cuid())

  broadcastId     String
  broadcast       ClientBroadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)

  // Получатель
  clientId        String
  telegramId      BigInt

  // Статус
  status          String    @default("pending") // pending, sent, delivered, failed
  sentAt          DateTime?
  error           String?

  createdAt       DateTime  @default(now())

  @@index([broadcastId, status])
  @@index([clientId])
}
